## 一、数据迁移

1. 没有修改数据的情况下，可以不用注册 **migrate** 方法，在 tables 里声明就可以了
2. 表的声明顺序必须与业务逻辑的插入顺序一致，避免持续迁移可能出现的逻辑错误
3. 返回的 event 跟原始 event 完全一样的情况下，不需要注册 Migrate 或者 On 方法
4. 没有修改 XXX 表的情况下，声明 XXX 表时，**ReadOnly** 要设成 true
5. 通常的删除方式是返回空数组，而不是把 action 改成 delete
6. 如果默认值是 NULL，应该使用 **types.NullValue()**
7. 如果默认值是空字符串，应该使用 **types.TextValue("")**
8. 没有将传入的 event 加入 events。这样虽然单个迁移不会出现问题，但在有下游迁移时，会导致下游迁移完全接收不到此事件
9. **types.IntValue**、**types.Int64Value**、**types.NewValue**、**types.NullValue** 等方法会生成新的 *BytesValue，不能用于直接比较
10. 处理时间类型的值时，用在原有值基础上加固定数的方式来做，原因：迁移和 API 可能跑在不同的机器上，分布式系统里面不能保证两台机器的时间是一样的，尤其在持续迁移的时候，接受到事件可能就间隔 1 秒，两台机器间相差几秒是非常正常的事情。
11. update_stamp 不能只处理 insert，update 才是最常见的操作，所以处理update_stamp的时候，一般使用 **MigrateInsertOrUpdate**
12. 加字段的情况下，insert 和 update 都需要响应，原因是：连续迁移时，如果下游也迁移了同样的表，并且响应了 update 事件，可能会接收到 Values 不完整的 event。

## 二、bang-api目录结构

### 2.1 app

核心代码

![1650425028056.png](image/项目/1650425028056.png)


#### 2.1.1 router

#### 2.1.2 middlewares

中间件主要为了让部分功能与具体的业务进行解耦，在增加中间件的时候始终考虑是否有必要成为一个中间件，又或者仅仅是一个 utils 方法

#### 2.1.3 controllers

负责处理请求参数，此层不可包含业务逻辑代码

#### 2.1.4 services

业务代码，负责处理业务单元，考虑 restful 相关各个业务模块之间的层级关系，避免循环依赖

#### 2.1.5 models

#### 2.1.6 util

### 2.2 migration

迁移脚本存放目录，已迁移至ones-migration项目

### 2.3 conf

配置存放目录

### 2.4 db

数据库文件存放目录

### 2.5 email_templates

邮件模版存放目录，此目录中的文件由前端维护，并交与后端更新

### 2.6 locales

资源文件存放目录

### 2.7 messages

短信资源文件存放目录

### 2.8 reports

常用默认报表模版数据存放目录

### 2.9 template

其他模版数据存放目录

### 2.10 tests

单元测试存放目录

### 2.11 vendor

第三方库存放目录

### 2.12 main.go

入口文件

### 2.13 scripts

(暂无规范，遗留问题)

### 2.14 swagger

(暂无规范，遗留问题)

### 2.15 gen

(暂无规范，遗留问题)

## 三、ones-migration目录结构

* template 目录存放模板文件。
* 各产品（project, wiki）分别有自己的 Makefile 和 bin 目录，bin 目录不进入版本控制。
* 每个迁移有自己独立的 go.mod，保证隔离。
* 每个迁移存放发生结构变更的表的 schema，在一次性迁移中需要用到。
* devops 目录存放 CI 构建脚本
